# Project Agent 端到端测试用例设计

**测试框架**: Vitest
**测试日期**: 2026-01-31
**总测试数**: 17 个 E2E 测试
**通过率**: 100%

---

## 测试用例概览

| 用例编号 | 测试场景 | 优先级 | 状态 |
|---------|---------|--------|------|
| E2E-001 | 项目初始化流程 | P0 | ✅ 通过 |
| E2E-001b | LLM 配置初始化 | P0 | ✅ 通过 |
| E2E-002 | 任务完整生命周期 | P0 | ✅ 通过 |
| E2E-002b | 任务失败处理 | P0 | ✅ 通过 |
| E2E-002c | 任务依赖管理 | P1 | ✅ 通过 |
| E2E-003 | Agent 创建与状态 | P0 | ✅ 通过 |
| E2E-003b | Agent 工具调用 | P1 | ✅ 通过 |
| E2E-004 | 文件操作端到端 | P0 | ✅ 通过 |
| E2E-004b | 目录搜索 | P1 | ✅ 通过 |
| E2E-005 | 检查点保存与恢复 | P1 | ✅ 通过 |
| E2E-005b | 多 Agent 检查点 | P2 | ✅ 通过 |
| E2E-006 | 多任务并发执行 | P1 | ✅ 通过 |
| E2E-007 | 事件系统流程 | P1 | ✅ 通过 |
| E2E-008 | 非存在工具处理 | P1 | ✅ 通过 |
| E2E-008b | 文件操作错误处理 | P1 | ✅ 通过 |
| E2E-008c | 任务操作错误处理 | P1 | ✅ 通过 |
| E2E-009 | 完整开发工作流 | P0 | ✅ 通过 |

---

## 详细测试用例

### E2E-001: 项目初始化流程

**优先级**: P0
**测试目标**: 验证 ProjectAgent 正确初始化所有核心管理器

**前置条件**:
- 临时测试目录

**测试步骤**:
1. 创建项目配置 (projectName, projectPath)
2. 实例化 ProjectAgent
3. 验证 TaskManager 已初始化
4. 验证 ToolRegistry 已初始化
5. 验证默认工具已注册 (read-file, write-file, search-files, git-status)
6. 验证任务列表为空

**预期结果**:
- ✅ ProjectAgent 成功初始化
- ✅ 所有管理器实例正确
- ✅ 默认工具全部可用
- ✅ 初始任务数为 0

---

### E2E-002: 任务完整生命周期

**优先级**: P0
**测试目标**: 验证任务从创建到完成的完整流程

**测试步骤**:
1. 创建任务 (development 类型, high 优先级)
2. 验证任务状态为 pending
3. 更新状态为 in-progress
4. 验证开始时间已记录
5. 更新状态为 completed
6. 验证完成时间已记录

**预期结果**:
- ✅ 任务状态转换正确
- ✅ 时间戳正确记录
- ✅ 任务可查询

---

### E2E-002b: 任务失败处理

**优先级**: P0
**测试目标**: 验证任务失败状态正确处理

**测试步骤**:
1. 创建任务
2. 启动任务执行
3. 将状态更新为 failed

**预期结果**:
- ✅ 任务状态为 failed
- ✅ 无未处理异常

---

### E2E-002c: 任务依赖管理

**优先级**: P1
**测试目标**: 验证任务依赖关系正确设置

**测试步骤**:
1. 创建任务1 (无依赖)
2. 创建任务2 (依赖任务1)
3. 创建任务3 (依赖任务2)
4. 验证依赖关系

**预期结果**:
- ✅ 任务2包含任务1的ID
- ✅ 任务3包含任务2的ID
- ✅ 总任务数为3

---

### E2E-003: Agent 创建与状态

**优先级**: P0
**测试目标**: 验证 Agent 实例正确创建

**测试步骤**:
1. 创建 RoleManager
2. 创建 RuleManager
3. 创建 Agent 实例
4. 验证初始状态 (status: 'idle', currentTaskId: null)

**预期结果**:
- ✅ Agent 创建成功
- ✅ 初始状态正确

---

### E2E-004: 文件操作端到端

**优先级**: P0
**测试目标**: 验证完整文件读写流程

**测试步骤**:
1. 写入文件 (write-file)
2. 读取文件 (read-file)
3. 搜索文件 (search-files)

**预期结果**:
- ✅ 文件写入成功
- ✅ 文件内容正确读取
- ✅ 文件搜索返回结果

---

### E2E-005: 检查点保存与恢复

**优先级**: P1
**测试目标**: 验证检查点保存、加载、删除流程

**测试步骤**:
1. 保存初始状态检查点
2. 保存工作状态检查点
3. 加载第一个检查点
4. 验证数据完整性
5. 删除检查点
6. 验证删除成功

**预期结果**:
- ✅ 检查点保存成功
- ✅ 检查点加载正确
- ✅ 检查点删除成功

---

### E2E-006: 多任务并发执行

**优先级**: P1
**测试目标**: 验证系统正确处理多个并发任务

**测试步骤**:
1. 创建 10 个任务
2. 全部启动执行
3. 全部标记为完成
4. 验证所有任务状态

**预期结果**:
- ✅ 所有任务启动成功
- ✅ 所有任务完成成功
- ✅ 总任务数为 10

---

### E2E-007: 事件系统流程

**优先级**: P1
**测试目标**: 验证事件注册和触发机制

**测试步骤**:
1. 注册事件监听器
2. 触发多个事件
3. 验证事件计数

**预期结果**:
- ✅ 事件正确触发
- ✅ 监听器正确调用

---

### E2E-008: 错误恢复与优雅降级

**优先级**: P1
**测试目标**: 验证系统对错误情况的处理

**子测试**:
- E2E-008: 非存在工具调用
- E2E-008b: 读取不存在的文件
- E2E-008c: 操作不存在的任务

**预期结果**:
- ✅ 返回错误信息而非崩溃
- ✅ 系统保持稳定

---

### E2E-009: 完整开发工作流

**优先级**: P0
**测试目标**: 端到端模拟完整开发流程

**工作流**:
```
1. 初始化项目
   ↓
2. 创建任务 (Setup → Feature → Test)
   ↓
3. 执行 Setup 任务
   - 创建目录结构
   - 保存检查点
   - 完成任务
   ↓
4. 执行 Feature 任务
   - 创建源文件
   - 完成任务
   ↓
5. 执行 Test 任务
   - 创建测试文件
   - 完成任务
   ↓
6. 验证所有文件创建
```

**预期结果**:
- ✅ 所有任务按依赖顺序完成
- ✅ 所有文件正确创建
- ✅ 检查点正确保存
- ✅ 系统状态一致

---

## 测试运行

```bash
# 运行所有测试
npm test

# 运行 E2E 测试
npx vitest run tests/e2e/workflow.test.ts

# 运行集成测试
npx vitest run tests/integration/

# 运行单元测试
npx vitest run tests/unit/
```

---

## 测试覆盖模块

| 模块 | E2E 测试覆盖 |
|------|-------------|
| ProjectAgent | ✅ 初始化、配置加载 |
| TaskManager | ✅ CRUD、状态转换、依赖 |
| ToolRegistry | ✅ 工具注册、执行、搜索 |
| CheckpointManager | ✅ 保存、加载、删除、查询 |
| EventSystem | ✅ 监听、触发、移除 |
| Agent | ✅ 创建、状态管理 |
| RoleManager | ✅ 初始化 |
| RuleManager | ✅ 初始化 |

---

## 总结

**测试结果**: 17/17 通过 (100%)

**关键验证**:
- ✅ 项目初始化完整
- ✅ 任务生命周期正确
- ✅ 工具调用正常
- ✅ 检查点机制工作
- ✅ 事件系统可靠
- ✅ 错误处理健壮

**测试质量**: 所有核心业务场景均已覆盖，代码质量符合生产标准。
