# Bug Fix: Agent API 返回 500 错误

## 问题描述

**日期**: 2024-02-05
**严重程度**: High
**影响范围**: `/api/agents` 所有端点返回 500 错误

### 错误信息
```
expected 200 "OK", got 500 "Internal Server Error"
```

### 受影响的测试

| 测试文件 | 受影响测试数 |
|---------|------------|
| `tests/server-roles-agents.test.ts` | 8 个测试 |
| `tests/server.test.ts` | 1 个测试 |

### 具体测试
- `GET /api/agents` - 获取 Agent 列表
- `GET /api/agents/:id` - 获取单个 Agent
- `POST /api/agents` - 创建 Agent
- `POST /api/agents/:id/restart` - 重启 Agent
- `DELETE /api/agents/:id` - 删除 Agent

## 根因分析

### 问题位置
`tests/server-roles-agents.test.ts:123`

### 原因
测试代码中调用 `createAgentRouter()` 时**没有传入必需参数** `agentMgr`：

```typescript
// 问题代码
beforeEach(() => {
  app = express();
  app.use(express.json());
  app.use('/api/agents', createAgentRouter());  // ❌ 缺少 agentMgr 参数
});
```

`createAgentRouter` 函数的签名要求传入 `agentMgr: AgentMgr`：

```typescript
export function createAgentRouter(agentMgr: AgentMgr): Router {
  // ...
}
```

当 `agentMgr` 未传入时，函数接收到的值为 `undefined`，后续调用 `agentMgr.getAgents()` 时抛出 TypeError：

```
TypeError: Cannot read property 'getAgents' of undefined
```

Express 错误处理中间件将此错误转换为 500 响应。

### 代码流程
```
测试请求 GET /api/agents
    ↓
Express 路由匹配
    ↓
createAgentRouter.GET('/')
    ↓
agentMgr.getAgents()  ← agentMgr 为 undefined
    ↓
TypeError: Cannot read property 'getAgents' of undefined
    ↓
Express 错误处理 → 500 Internal Server Error
```

## 修复方案

### 修复内容

1. 在测试中创建 mock `AgentMgr` 和 `EventSystem`
2. 将 mock 对象传入 `createAgentRouter()`
3. 修复 restart/delete 测试逻辑（先创建再操作）

### 修改文件

**文件 1**: `tests/server-roles-agents.test.ts`

```typescript
import { AgentMgr } from '../src/core/agent-mgr.js';
import { EventSystem } from '../src/core/events.js';

describe('Agent Routes', () => {
  let app: express.Application;
  let agentMgr: AgentMgr;
  let eventSystem: EventSystem;

  beforeEach(() => {
    eventSystem = new EventSystem();
    agentMgr = new AgentMgr('test-project', eventSystem);

    app = express();
    app.use(express.json());
    app.use('/api/agents', createAgentRouter(agentMgr));  // ✅ 传入 agentMgr
  });

  // ... tests
});
```

**文件 2**: `tests/server.test.ts`

```typescript
import { AgentMgr } from '../src/core/agent-mgr.js';
import { EventSystem } from '../src/core/events.js';

describe('Agent Router', () => {
  it('should list agents', async () => {
    const eventSystem = new EventSystem();
    const agentMgr = new AgentMgr('test-project', eventSystem);
    const router = createAgentRouter(agentMgr);
    // ...
  });
});
```

## 设计建议

### 问题反思

1. **缺少依赖注入验证**
   - `createAgentRouter` 函数参数缺少运行时验证
   - TypeScript 类型检查无法捕获测试中的调用错误

2. **错误处理不够友好**
   - 当 `agentMgr` 为 undefined 时，应该返回更明确的错误信息
   - 500 错误对调用者不友好

### 改进建议

#### 1. 添加参数验证

```typescript
export function createAgentRouter(agentMgr: AgentMgr): Router {
  if (!agentMgr) {
    throw new Error('AgentMgr is required');
  }
  // ...
}
```

#### 2. 使用工厂模式

```typescript
interface RouterFactory {
  createAgentRouter(agentMgr: AgentMgr): Router;
}

export const agentRouterFactory: RouterFactory = {
  createAgentRouter(agentMgr: AgentMgr): Router {
    // ...
  }
};
```

#### 3. 依赖注入容器

考虑使用依赖注入框架（如 inversify）来管理依赖关系。

## 验证步骤

1. ✅ 运行测试确认问题
2. ✅ 应用修复 (tests/server-roles-agents.test.ts)
3. ✅ 应用修复 (tests/server.test.ts)
4. ✅ 运行测试确认修复有效
5. ✅ 检查其他路由是否有类似问题

## 相关测试

修复后的测试覆盖：
- ✅ `GET /api/agents` - 返回空数组
- ✅ `GET /api/agents/?projectId=test` - 按项目筛选
- ✅ `GET /api/agents/?status=idle` - 按状态筛选
- ✅ `GET /api/agents/:id` - 404 for non-existent
- ✅ `POST /api/agents` - 创建 Agent
- ✅ `POST /api/agents/:id/restart` - 重启 Agent
- ✅ `DELETE /api/agents/:id` - 删除 Agent

## 附录：测试结果

```
 ✓ tests/server-roles-agents.test.ts (17 tests) 112ms
 ✓ tests/server.test.ts (8 tests) 69ms
 ✓ 全部测试通过 (383 tests)
```

所有 Agent 路由测试通过。
