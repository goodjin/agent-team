# 任务工作目录管理功能 - 需求文档

## 1. 项目概述

### 1.1 背景

当前 Agent Team 系统在任务执行过程中存在以下问题：
- 任务没有明确的工作目录概念，所有文件操作都在项目根目录进行
- 生成的代码和文件无法自动归类到独立目录
- 文件读写操作缺乏安全边界控制，存在误操作风险
- 任务输出混杂在一起，难以管理和清理

### 1.2 目标

为每个任务引入独立的工作目录机制：
1. 支持任务级别的目录隔离
2. 默认在 `workspace/{task-id}` 目录下工作
3. 所有文件读写操作必须在工作目录内进行
4. 提供清晰的项目结构和文件组织方式

## 2. 功能需求

### 2.1 工作目录配置

#### 2.1.1 默认工作目录
- 路径格式：`{project-root}/workspace/{task-id}`
- 自动创建目录结构
- 支持相对路径和绝对路径

#### 2.1.2 自定义工作目录
- 任务创建时可指定 `workDir` 参数
- 支持以下格式：
  - 绝对路径：`/Users/xxx/project`
  - 相对路径：`./my-tasks/task-1`
  - 命名空间格式：`workspace:task-name`

#### 2.1.3 目录结构模板
```
workspace/
├── {task-id}/
│   ├── src/              # 源代码
│   ├── tests/            # 测试文件
│   ├── docs/             # 文档
│   ├── output/           # 生成物
│   └── .agent-state/     # 代理状态
```

### 2.2 提示词集成

#### 2.2.1 工作目录说明模板
```
## 工作目录
当前任务的工作目录: {workDir}
请在此目录下创建和管理所有文件。
所有文件路径都应相对于此目录。

目录结构:
- src/: 存放源代码
- tests/: 存放测试文件
- docs/: 存放文档
- output/: 存放生成物

重要: 所有文件读写操作必须在此工作目录内进行。
```

#### 2.2.2 动态目录信息
- 在提示词中注入当前目录结构
- 列出已有文件和目录
- 提供目录使用建议

### 2.3 文件读写安全

#### 2.3.1 工具级别检查
所有文件操作工具必须验证路径是否在工作目录内：

```typescript
// 检查逻辑
function validateWorkDir(filePath: string, workDir: string): boolean {
  const resolvedPath = path.resolve(filePath);
  const resolvedWorkDir = path.resolve(workDir);
  return resolvedPath.startsWith(resolvedWorkDir + path.sep);
}
```

#### 2.3.2 错误处理
- 路径越界时返回明确错误信息
- 错误格式：
  ```
  ❌ 安全错误: 路径越界
  当前工作目录: {workDir}
  请求路径: {requestedPath}
  原因: 只能在工作目录内进行文件操作
  ```

### 2.4 任务生命周期

#### 2.4.1 创建阶段
- 生成唯一 task-id
- 创建工作目录结构
- 初始化工作目录状态

#### 2.4.2 执行阶段
- 注入工作目录信息到提示词
- 传递 workDir 到所有工具调用
- 记录文件操作日志

#### 2.4.3 完成阶段
- 保留工作目录（可选）
- 清理临时文件
- 汇总生成的文件列表

## 3. 非功能需求

### 3.1 性能需求
- 目录创建: < 100ms
- 路径验证: < 1ms
- 支持并发任务: 10+ 任务同时执行

### 3.2 安全需求
- 路径遍历攻击防护
- 符号链接处理策略
- 权限最小化原则

### 3.3 兼容性需求
- 现有 API 兼容
- 现有角色提示词向后兼容
- 支持项目根目录操作（白名单）

## 4. 用户故事

### US-1: 任务使用默认工作目录
```
作为: 开发者
我希望: 任务自动使用 workspace/{task-id} 目录
以便: 保持项目根目录整洁
```

### US-2: 自定义工作目录
```
作为: 开发者
我希望: 为特定任务指定工作目录
以便: 将相关任务的文件组织在一起
```

### US-3: 文件操作安全检查
```
作为: 系统管理员
我希望: 所有文件操作都在工作目录内
以便: 防止误操作破坏项目文件
```

### US-4: 提示词集成
```
作为: AI 助手
我希望: 在提示词中了解当前工作目录
以便: 正确生成文件路径
```

## 5. 验收标准

### AC-1: 工作目录自动创建
- [ ] 给定任务创建请求
- [ ] 系统自动创建 workspace/{task-id} 目录
- [ ] 目录结构符合模板

### AC-2: 路径验证
- [ ] 工作目录内的文件操作: 成功
- [ ] 工作目录外的文件操作: 失败并返回明确错误
- [ ] 路径遍历攻击: 被阻止

### AC-3: 提示词集成
- [ ] 所有角色提示词包含工作目录说明
- [ ] 目录结构正确显示
- [ ] 文件路径相对于工作目录

### AC-4: 向后兼容
- [ ] 现有 API 无需修改
- [ ] 现有工作流正常执行
- [ ] 现有角色行为不变

## 6. 范围外

- 文件版本管理
- 目录压缩/备份
- 跨任务文件共享
- 工作目录模板自定义
