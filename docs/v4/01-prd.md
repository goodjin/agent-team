# v4 ä»»åŠ¡ç®¡ç†ä¼˜åŒ– - äº§å“éœ€æ±‚æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 èƒŒæ™¯

å½“å‰ Agent Team ç³»ç»Ÿåœ¨ä»»åŠ¡ç®¡ç†æ–¹é¢å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **ä»»åŠ¡ä¸æŒä¹…åŒ–**: æœåŠ¡é‡å¯åæ‰€æœ‰ä»»åŠ¡ä¸¢å¤±ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ
2. **æ‰‹åŠ¨è§¦å‘æ‰§è¡Œ**: ä»»åŠ¡åˆ›å»ºåéœ€è¦äººå·¥ç‚¹å‡»æ‰èƒ½å¼€å§‹
3. **å¤±è´¥æ— æ³•é‡è¯•**: ä»»åŠ¡å¤±è´¥åæ²¡æœ‰é‡è¯•æœºåˆ¶ï¼Œåªèƒ½æ‰‹åŠ¨é‡æ–°åˆ›å»º
4. **ç»“æœå±•ç¤ºç®€é™‹**: ä»»åŠ¡ç»“æœåªæœ‰æ–‡æœ¬ï¼Œç¼ºä¹ç›®å½•ç»“æ„å’Œå¯è§†åŒ–å±•ç¤º

### 1.2 ç›®æ ‡

å¢å¼ºä»»åŠ¡ç®¡ç†èƒ½åŠ›ï¼š
1. **æŒä¹…åŒ–æœºåˆ¶**: ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨ä¿å­˜åˆ°ç£ç›˜ï¼Œé‡å¯åå¯æ¢å¤
2. **è‡ªåŠ¨æ‰§è¡Œ**: ä»»åŠ¡åˆ›å»ºåç«‹å³å¼€å§‹æ‰§è¡Œï¼Œæ— éœ€äººå·¥å¹²é¢„
3. **é‡è¯•æœºåˆ¶**: ä»»åŠ¡å¤±è´¥åæ”¯æŒä¸€é”®é‡è¯•
4. **æˆæœå±•ç¤º**: æ”¯æŒç›®å½•ç»“æ„å±•ç¤ºå’Œç½‘é¡µ iframe é¢„è§ˆ

---

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 ä»»åŠ¡æŒä¹…åŒ–

#### 2.1.1 æŒä¹…åŒ–å†…å®¹
| ç±»åˆ« | å†…å®¹ | å­˜å‚¨ä½ç½® |
|------|------|---------|
| ä»»åŠ¡å…ƒæ•°æ® | id, title, description, status, createdAt | tasks.json |
| ä»»åŠ¡è¾“å…¥ | input, variables, workDir | tasks.json |
| ä»»åŠ¡è¿›åº¦ | currentStep, completedSteps, progress | tasks.json |
| æ‰§è¡Œè®°å½• | executionRecords, logs | execution/{taskId}.json |
| ä»»åŠ¡äº§ç‰© | files, outputs | workspace/{taskId}/ |

#### 2.1.2 æŒä¹…åŒ–æ—¶æœº
- **å®æ—¶**: ä»»åŠ¡çŠ¶æ€å˜æ›´ç«‹å³ä¿å­˜
- **å‘¨æœŸ**: æ¯ 30 ç§’è‡ªåŠ¨ä¿å­˜è¿›åº¦
- **å…³é”®ç‚¹**: åˆ›å»ºæ—¶ã€æ‰§è¡Œä¸­æ¯æ­¥ã€å®Œæˆæ—¶

#### 2.1.3 æ¢å¤æœºåˆ¶
- å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ `tasks.json`
- é‡å»ºä»»åŠ¡çŠ¶æ€æ ‘
- æ¢å¤æ‰§è¡Œè®°å½•
- æ ‡è®°"é‡å¯è¿‡çš„ä»»åŠ¡"

#### 2.1.4 æ•°æ®ç»“æ„

```typescript
interface PersistedTask {
  id: string;
  type: string;
  title: string;
  description: string;
  status: TaskStatus;
  priority: Priority;
  assignedRole?: string;
  input: TaskInput;
  output?: TaskOutput;
  metadata: {
    createdAt: Date;
    updatedAt: Date;
    lastExecutedAt?: Date;
    restartCount: number;
    isRecovered: boolean;
  };
  progress: {
    currentStep?: string;
    completedSteps: string[];
    percentage: number;
    message?: string;
  };
  executionRecords: ExecutionRecord[];
}

interface TaskStorage {
  version: '1.0';
  lastSavedAt: Date;
  tasks: Map<string, PersistedTask>;
  taskOrder: string[];  // ä»»åŠ¡åˆ›å»ºé¡ºåº
}
```

---

### 2.2 è‡ªåŠ¨æ‰§è¡Œ

#### 2.2.1 è§¦å‘æœºåˆ¶
| äº‹ä»¶ | è§¦å‘æ¡ä»¶ | åŠ¨ä½œ |
|------|---------|------|
| ä»»åŠ¡åˆ›å»º | createTask() å®Œæˆ | ç«‹å³è¿›å…¥é˜Ÿåˆ— |
| ä»»åŠ¡å°±ç»ª | ä¾èµ–ä»»åŠ¡å®Œæˆ | è‡ªåŠ¨è°ƒåº¦ |
| å®šæ—¶æ£€æŸ¥ | é˜Ÿåˆ—ç©ºé—²æ—¶ | è¡¥å……è°ƒåº¦ |

#### 2.2.2 æ‰§è¡Œé˜Ÿåˆ—
```typescript
interface ExecutionQueue {
  pending: Task[];      // ç­‰å¾…æ‰§è¡Œ
  running: Task[];     // æ­£åœ¨æ‰§è¡Œ
  completed: Task[];   // å·²å®Œæˆ
  failed: Task[];      // å¤±è´¥å¾…é‡è¯•
}
```

#### 2.2.3 è°ƒåº¦ç­–ç•¥
- **ä¼˜å…ˆçº§è°ƒåº¦**: é«˜ä¼˜å…ˆçº§ä»»åŠ¡å…ˆæ‰§è¡Œ
- **ä¾èµ–è°ƒåº¦**: ä¾èµ–ä»»åŠ¡å®Œæˆåè‡ªåŠ¨è°ƒåº¦ä¸‹æ¸¸
- **å¹¶å‘æ§åˆ¶**: æœ€å¤š N ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œ

---

### 2.3 å¤±è´¥é‡è¯•

#### 2.3.1 é‡è¯•é…ç½®
```typescript
interface RetryConfig {
  maxAttempts: number;      // æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 3
  initialDelayMs: number;   // åˆå§‹å»¶è¿Ÿï¼Œé»˜è®¤ 1000ms
  maxDelayMs: number;       // æœ€å¤§å»¶è¿Ÿï¼Œé»˜è®¤ 60000ms
  backoffMultiplier: number;// é€€é¿å€æ•°ï¼Œé»˜è®¤ 2
  retryableStatuses: TaskStatus[]; // å¯é‡è¯•çŠ¶æ€
}
```

#### 2.3.2 é‡è¯•æµç¨‹
```
ä»»åŠ¡å¤±è´¥
    â”‚
    â”œâ”€ æ£€æŸ¥æ˜¯å¦å¯é‡è¯•
    â”‚   â”œâ”€ æ˜¯å¦è¾¾åˆ°æœ€å¤§æ¬¡æ•°ï¼Ÿ
    â”‚   â””â”€ é”™è¯¯æ˜¯å¦å¯é‡è¯•ï¼Ÿ
    â”‚
    â”œâ”€ å¯é‡è¯•
    â”‚   â”œâ”€ è®¡ç®—å»¶è¿Ÿæ—¶é—´
    â”‚   â”œâ”€ åˆ›å»ºé‡è¯•ä»»åŠ¡
    â”‚   â””â”€ åŠ å…¥é‡è¯•é˜Ÿåˆ—
    â”‚
    â””â”€ ä¸å¯é‡è¯•
        â””â”€ æ ‡è®°ä¸ºæœ€ç»ˆå¤±è´¥
```

#### 2.3.3 é‡è¯•å†å²
```typescript
interface RetryHistory {
  attemptNumber: number;
  failedAt: Date;
  error: string;
  delayMs: number;
  retriedAt?: Date;
  retriedBy?: string;  // æ‰‹åŠ¨é‡è¯•çš„ç”¨æˆ·
}
```

---

### 2.4 æˆæœå±•ç¤º

#### 2.4.1 ç›®å½•ç»“æ„å±•ç¤º
```
ä»»åŠ¡æˆæœ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py          [å¤åˆ¶æ–‡ä»¶å†…å®¹]
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_main.py
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ README.md
â””â”€â”€ output/
    â””â”€â”€ result.json
```

#### 2.4.2 æ–‡ä»¶é¢„è§ˆ
| æ–‡ä»¶ç±»å‹ | é¢„è§ˆæ–¹å¼ |
|---------|---------|
| ä»£ç æ–‡ä»¶ | Syntax Highlight ä»£ç å±•ç¤º |
| å›¾ç‰‡æ–‡ä»¶ | Image é¢„è§ˆ |
| Markdown | Markdown Render |
| JSON/YAML | Pretty Print |
| HTML | iframe åµŒå…¥ |
| æ–‡æœ¬æ–‡ä»¶ | Text Content |

#### 2.4.3 iframe åµŒå…¥
```typescript
interface WebPreview {
  type: 'iframe' | 'link' | 'modal';
  url?: string;
  content?: string;
  width?: string;
  height?: string;
}
```

#### 2.4.4 UI å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡: å¼€å‘å­—æ¯æ¸¸æˆ                          [çŠ¶æ€: å®Œæˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æˆæœæ–‡ä»¶                                    [+ ä¸Šä¼ ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ src/          â”‚                                  â”‚
â”‚   ğŸ“„ main.py     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   ğŸ“„ utils.py    â”‚     â”‚                        â”‚  â”‚
â”‚ ğŸ“ tests/        â”‚     â”‚   iframe é¢„è§ˆåŒºåŸŸ      â”‚  â”‚
â”‚   ğŸ“„ test.py     â”‚     â”‚                        â”‚  â”‚
â”‚ ğŸ“ docs/         â”‚     â”‚   æ”¯æŒ HTML ç½‘é¡µé¢„è§ˆ    â”‚  â”‚
â”‚   ğŸ“„ README.md    â”‚     â”‚                        â”‚  â”‚
â”‚ ğŸ“ output/        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   ğŸ“„ result.json  â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. éåŠŸèƒ½éœ€æ±‚

### 3.1 æ€§èƒ½éœ€æ±‚
- æŒä¹…åŒ–å»¶è¿Ÿ: < 100ms
- ä»»åŠ¡æ¢å¤: < 1s (100 ä¸ªä»»åŠ¡)
- å†…å­˜å ç”¨: æ¯ä»»åŠ¡ < 10KB å…ƒæ•°æ®

### 3.2 å¯é æ€§éœ€æ±‚
- æŒä¹…åŒ–æˆåŠŸç‡: 99.99%
- æ•°æ®ä¸€è‡´æ€§: æœ€ç»ˆä¸€è‡´
- é‡è¯•é˜Ÿåˆ—: æŒä¹…åŒ–å­˜å‚¨

### 3.3 å®‰å…¨éœ€æ±‚
- ä»»åŠ¡æ•°æ®: åŠ å¯†å­˜å‚¨
- æˆæœæ–‡ä»¶: æ²™ç®±éš”ç¦»
- iframe: XSS é˜²æŠ¤

---

## 4. ç”¨æˆ·æ•…äº‹

### US-1: ä»»åŠ¡æŒä¹…åŒ–
```
ä½œä¸º: å¼€å‘è€…
æˆ‘å¸Œæœ›: æˆ‘çš„ä»»åŠ¡åœ¨é‡å¯åä»ç„¶å­˜åœ¨
ä»¥ä¾¿: å¯ä»¥ç»§ç»­ä¹‹å‰çš„å·¥ä½œï¼Œä¸ä¼šä¸¢å¤±è¿›åº¦
```

### US-2: è‡ªåŠ¨æ‰§è¡Œ
```
ä½œä¸º: å¼€å‘è€…
æˆ‘å¸Œæœ›: ä»»åŠ¡åˆ›å»ºåè‡ªåŠ¨å¼€å§‹æ‰§è¡Œ
ä»¥ä¾¿: ä¸ç”¨æ¯æ¬¡éƒ½è®°å¾—æ‰‹åŠ¨ç‚¹å‡»å¼€å§‹
```

### US-3: å¤±è´¥é‡è¯•
```
ä½œä¸º: å¼€å‘è€…
æˆ‘å¸Œæœ›: ä»»åŠ¡å¤±è´¥åå¯ä»¥ä¸€é”®é‡è¯•
ä»¥ä¾¿: ä¸ç”¨æ‰‹åŠ¨é‡æ–°åˆ›å»ºä»»åŠ¡ï¼ŒèŠ‚çœæ—¶é—´
```

### US-4: æŸ¥çœ‹æˆæœ
```
ä½œä¸º: å¼€å‘è€…
æˆ‘å¸Œæœ›: èƒ½æŒ‰ç›®å½•ç»“æ„æŸ¥çœ‹ä»»åŠ¡äº§ç”Ÿçš„æ–‡ä»¶
ä»¥ä¾¿: æ¸…æ™°åœ°äº†è§£ä»»åŠ¡äº§å‡ºçš„å†…å®¹
```

### US-5: ç½‘é¡µé¢„è§ˆ
```
ä½œä¸º: å¼€å‘è€…
æˆ‘å¸Œæœ›: HTML æˆæœå¯ä»¥ç›´æ¥åœ¨é¡µé¢ä¸­é¢„è§ˆ
ä»¥ä¾¿: ä¸ç”¨ä¸‹è½½æ–‡ä»¶å°±èƒ½æŸ¥çœ‹æ•ˆæœ
```

---

## 5. éªŒæ”¶æ ‡å‡†

### AC-1: ä»»åŠ¡æŒä¹…åŒ–
- [ ] ä»»åŠ¡åˆ›å»ºåä¿å­˜åˆ° tasks.json
- [ ] ä»»åŠ¡çŠ¶æ€å˜æ›´å®æ—¶ä¿å­˜
- [ ] æœåŠ¡é‡å¯åè‡ªåŠ¨æ¢å¤æ‰€æœ‰ä»»åŠ¡
- [ ] æ¢å¤çš„ä»»åŠ¡æ ‡è®° isRecovered=true
- [ ] æ¢å¤åå¯ä»¥ç»§ç»­æ‰§è¡Œ

### AC-2: è‡ªåŠ¨æ‰§è¡Œ
- [ ] ä»»åŠ¡åˆ›å»ºåè‡ªåŠ¨è¿›å…¥æ‰§è¡Œé˜Ÿåˆ—
- [ ] æ— éœ€äººå·¥ç‚¹å‡»ç«‹å³æ‰§è¡Œ
- [ ] ä¾èµ–ä»»åŠ¡å®Œæˆåè‡ªåŠ¨è°ƒåº¦
- [ ] æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦

### AC-3: å¤±è´¥é‡è¯•
- [ ] ä»»åŠ¡å¤±è´¥åæ˜¾ç¤ºé‡è¯•æŒ‰é’®
- [ ] æ”¯æŒæ‰‹åŠ¨é‡è¯•
- [ ] æ”¯æŒé…ç½®è‡ªåŠ¨é‡è¯•
- [ ] è®°å½•é‡è¯•å†å²
- [ ] è¾¾åˆ°æœ€å¤§æ¬¡æ•°ååœæ­¢é‡è¯•

### AC-4: æˆæœå±•ç¤º
- [ ] æŒ‰ç›®å½•ç»“æ„å±•ç¤ºæ–‡ä»¶
- [ ] æ”¯æŒä»£ç é«˜äº®
- [ ] æ”¯æŒå›¾ç‰‡é¢„è§ˆ
- [ ] æ”¯æŒ HTML iframe é¢„è§ˆ
- [ ] æ”¯æŒæ–‡ä»¶ä¸‹è½½

---

## 6. èŒƒå›´å¤–

- ä»»åŠ¡ç‰ˆæœ¬ç®¡ç†
- ä»»åŠ¡åˆ†æ”¯/åˆå¹¶
- å®æ—¶åä½œç¼–è¾‘
- ä»»åŠ¡æƒé™æ§åˆ¶
